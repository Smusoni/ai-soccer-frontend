<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ball Knowledge</title>
  <style>
    :root { --bg:#0b0b0b; --card:#141414; --muted:#9aa0a6; --text:#e8eaed; --accent:#00ff95; }
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial;}
    body{margin:0;background:#0b0b0b;color:var(--text)}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;padding:18px;margin:16px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid #222;background:#0f0f0f;color:var(--text)}
    input::placeholder{color:#8a8f98}
    button{border:none;background:linear-gradient(90deg,#00ff95,#19d3ff);color:#000;font-weight:700;cursor:pointer}
    h1{font-size:36px;margin:8px 0;text-shadow:0 0 15px rgba(0,255,149,.35)}
    h3{margin:10px 0 14px}
    .muted{color:var(--muted)}
    ul{list-style:none;padding:0;margin:10px 0}
    li{padding:8px 10px;background:#0f0f0f;border:1px solid #222;border-radius:10px;margin:6px 0;cursor:pointer}
    .hide{display:none !important}
    .ok{color:#00e676}
    .err{color:#ff6b6b}
    #splash{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:5}
    #splash .pulse{width:14px;height:14px;border-radius:50%;background:#00ff95;box-shadow:0 0 15px #00ff95;animation:pulse 1.2s infinite}
    @keyframes pulse{0%{transform:scale(.9);opacity:.7}50%{transform:scale(1.25);opacity:1}100%{transform:scale(.9);opacity:.7}}
  </style>
</head>
<body>

  <!-- Splash -->
  <div id="splash"><div class="pulse"></div></div>

  <header class="container">
    <h1>Ball Knowledge</h1>
    <p class="muted">Analyze. Learn. Evolve.</p>
  </header>

  <!-- Account -->
  <section class="card container" id="accountCard">
    <h3>Account</h3>
    <div class="row">
      <input id="username" type="text" placeholder="Username" style="min-width:220px">
      <input id="password" type="password" placeholder="Password" style="min-width:220px">
      <button id="signupBtn">Sign Up</button>
      <button id="loginBtn">Login</button>
      <button id="logoutBtn">Logout</button>
    </div>
    <p id="authMsg" class="muted"></p>
  </section>

  <!-- Upload (“attachment” page) -->
  <section class="card container hide" id="uploadCard">
    <h3>Upload Player Footage</h3>
    <p class="muted">Upload a short clip (max ~60s). Accepted: MP4, MOV, WEBM.</p>
    <div class="row">
      <input id="clipFile" type="file" accept="video/*">
      <button id="uploadBtn">Upload</button>
    </div>
    <p id="uploadMsg" class="muted"></p>
  </section>

  <!-- Profile (“describe yourself” page) -->
  <section class="card container hide" id="profileCard">
    <h3>Player Profile</h3>
    <div class="row">
      <input id="height"   type="number" placeholder="Height (cm)">
      <input id="weight"   type="number" placeholder="Weight (kg)">
    </div>
    <div class="row">
      <input id="foot"     type="text"    placeholder="Dominant Foot">
      <input id="position" type="text"    placeholder="Position">
    </div>
    <div class="row">
      <input id="dob" type="date" placeholder="DOB">
      <button id="saveProfileBtn">Save Profile</button>
    </div>
    <p id="profileMsg" class="muted"></p>
  </section>

  <!-- Add player -->
  <section class="card container">
    <h3>Add player</h3>
    <div class="row">
      <input id="name" type="text" placeholder="Player name">
      <button id="addBtn">Add</button>
    </div>
    <p id="msg" class="muted"></p>
  </section>

  <!-- Players -->
  <section class="card container">
    <h3>Players</h3>
    <button id="refresh">Refresh list</button>
    <ul id="list"></ul>
  </section>

  <script>
  // ========= CONFIG =========
  const BASE =
    location.hostname.endsWith('github.io')
      ? 'https://ai-soccer-backend-2-production.up.railway.app'
      : '';

  // Cloudinary (unsigned)
  const CLOUD_NAME    = 'dblconpx8';                 // <- your cloud name
  const UPLOAD_PRESET = 'ballknowledge_unsigned';    // <- your unsigned preset

  // ========= UTIL: DOM + token helpers =========
  const $ = (id) => document.getElementById(id);
  const setToken = (t) => localStorage.setItem('bk_token', t);
  const getToken = () => localStorage.getItem('bk_token');
  const clearToken = () => localStorage.removeItem('bk_token');

  // Generic fetch that auto-injects JWT if present
  async function api(path, opts = {}) {
    const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
    const t = getToken();
    if (t) headers['Authorization'] = 'Bearer ' + t;
    const r = await fetch(`${BASE}${path}`, { ...opts, headers });
    return r.json();
  }

  // ========= SECTION TOGGLING (flow control) =========
  const accountCard = $('accountCard');
  const uploadCard  = $('uploadCard');
  const profileCard = $('profileCard');

  function showAccount() {
    accountCard.classList.remove('hide');
    uploadCard.classList.add('hide');
    profileCard.classList.add('hide');
  }
  function showUploadAndProfile() {
    accountCard.classList.remove('hide'); // keep account visible if you like; or hide:
    // accountCard.classList.add('hide');
    uploadCard.classList.remove('hide');
    profileCard.classList.remove('hide');
    // scroll to Upload
    setTimeout(() => uploadCard.scrollIntoView({behavior:'smooth', block:'start'}), 50);
  }

  // ========= ELEMENTS =========
  const usernameEl = $('username');
  const passwordEl = $('password');
  const signupBtn  = $('signupBtn');
  const loginBtn   = $('loginBtn');
  const logoutBtn  = $('logoutBtn');
  const authMsg    = $('authMsg');

  const saveProfileBtn = $('saveProfileBtn');
  const heightEl   = $('height');
  const weightEl   = $('weight');
  const footEl     = $('foot');
  const positionEl = $('position');
  const dobEl      = $('dob');
  const profileMsg = $('profileMsg');

  const addBtn     = $('addBtn');
  const nameEl     = $('name');
  const msgEl      = $('msg');
  const refreshBtn = $('refresh');
  const listEl     = $('list');

  const clipInput  = $('clipFile');
  const uploadBtn  = $('uploadBtn');
  const uploadMsg  = $('uploadMsg');

  // ========= AUTH =========
  async function signup(username, password) {
    const out = await api('/api/signup', {
      method: 'POST',
      body: JSON.stringify({ username, password })
    });
    return out;
  }
  async function login(username, password) {
    const out = await api('/api/login', {
      method: 'POST',
      body: JSON.stringify({ username, password })
    });
    return out;
  }
  function setAuthMessage(text, ok=true) {
    authMsg.textContent = text;
    authMsg.className = ok ? 'ok' : 'err';
  }

  // ========= PROFILE =========
  async function saveProfile(payload) {
    const out = await api('/api/profile', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    return out;
  }

  // ========= PLAYERS =========
  async function refresh() {
    try {
      if (listEl) listEl.innerHTML = '<li class="muted">Loading…</li>';
      const data = await api('/api/players', { method:'GET' });
      if (!listEl) return;
      const players = data.players || [];
      if (!players.length) {
        listEl.innerHTML = '<li class="muted">No players yet.</li>';
        return;
      }
      listEl.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        li.textContent = typeof p==='string' ? p : (p.name || '(unnamed)');
        listEl.appendChild(li);
      });
    } catch (e) {
      console.error('[BK] refresh error:', e);
      if (listEl) listEl.innerHTML = '<li class="err">Failed to load players. Server may be offline.</li>';
    }
  }

  async function addPlayer() {
    const name = nameEl.value.trim();
    if (!name) return;
    try {
      const out = await api('/api/player', {
        method: 'POST',
        body: JSON.stringify({ name })
      });
      msgEl.textContent = out.ok ? `Added: ${name}` : (out.error || 'Could not add player');
      msgEl.className = out.ok ? 'ok' : 'err';
      if (out.ok) { nameEl.value=''; await refresh(); }
    } catch (e) {
      console.error('[BK] add error:', e);
      msgEl.textContent = 'Network error';
      msgEl.className = 'err';
    }
  }

  // ========= CLOUDINARY DIRECT UPLOAD =========
  async function uploadToCloudinary(file) {
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);
    const r = await fetch(url, { method:'POST', body: fd });
    return r.json();
  }

  // ========= WIRE UP =========
  if (signupBtn) signupBtn.onclick = async () => {
    const u = usernameEl.value.trim();
    const p = passwordEl.value.trim();
    if (!u || !p) return setAuthMessage('Enter username & password', false);
    setAuthMessage('Creating account…');
    const out = await signup(u,p);
    if (out.ok) {
      setAuthMessage('Account created ✅ — Please log in now', true);
    } else {
      setAuthMessage(out.error || 'Signup failed', false);
    }
  };

  if (loginBtn) loginBtn.onclick = async () => {
    const u = usernameEl.value.trim();
    const p = passwordEl.value.trim();
    if (!u || !p) return setAuthMessage('Enter username & password', false);
    setAuthMessage('Logging in…');
    const out = await login(u,p);
    if (out.ok && out.token) {
      setToken(out.token);
      setAuthMessage(`Welcome, ${out.user?.username || u} ✅`, true);
      showUploadAndProfile();               // go to Upload + Profile after login
    } else {
      setAuthMessage(out.error || 'Login failed', false);
    }
  };

  if (logoutBtn) logoutBtn.onclick = () => {
    clearToken();
    setAuthMessage('Logged out', true);
    showAccount();
  };

  if (saveProfileBtn) saveProfileBtn.onclick = async () => {
    const payload = {
      height:   heightEl.value.trim(),
      weight:   weightEl.value.trim(),
      foot:     footEl.value.trim(),
      position: positionEl.value.trim(),
      dob:      dobEl.value
    };
    profileMsg.textContent = 'Saving…';
    const out = await saveProfile(payload);
    profileMsg.textContent = out.ok ? 'Profile saved ✅' : (out.error || 'Profile save failed');
    profileMsg.className = out.ok ? 'ok' : 'err';
  };

  if (addBtn) addBtn.onclick = addPlayer;
  if (refreshBtn) refreshBtn.onclick = refresh;

  if (uploadBtn) uploadBtn.onclick = async () => {
    const f = clipInput.files?.[0];
    if (!f) { uploadMsg.textContent = 'Choose a video first'; uploadMsg.className = 'err'; return; }
    uploadMsg.textContent = 'Uploading…';
    try {
      const up = await uploadToCloudinary(f);
      if (up.secure_url) {
        // Optionally notify backend you added a clip
        await api('/api/clip', {
          method:'POST',
          body: JSON.stringify({ url: up.secure_url, public_id: up.public_id })
        });
        uploadMsg.textContent = 'Uploaded ✅';
        uploadMsg.className = 'ok';
        clipInput.value = '';
      } else {
        uploadMsg.textContent = 'Upload failed';
        uploadMsg.className = 'err';
        console.warn('Cloudinary response:', up);
      }
    } catch (e) {
      uploadMsg.textContent = 'Network error';
      uploadMsg.className = 'err';
      console.error('[BK] cloudinary error:', e);
    }
  };

  // ========= SPLASH + INITIAL STATE =========
  window.addEventListener('error', e => console.error('[BK FrontError]', e?.error || e?.message));
  setTimeout(() => {
    $('splash')?.classList.add('hide');
    setTimeout(() => $('splash')?.remove(), 400);
  }, 800);

  // If user already logged in previously, reveal upload/profile immediately
  if (getToken()) showUploadAndProfile();
  refresh();
  </script>
</body>
</html>
