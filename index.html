<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ball Knowledge</title>
  <style>
    :root{--bg:#0b0b0b;--card:#141414;--muted:#9aa0a6;--text:#e8eaed;--line:#222}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;padding:18px;margin:16px 0;border:1px solid var(--line)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f0f0f;color:var(--text)}
    input,select{min-width:220px}
    input::placeholder{color:#8a8f98}
    button{border:none;background:linear-gradient(90deg,#00ff95,#19d3ff);color:#000;font-weight:700;cursor:pointer}
    h1{font-size:36px;margin:8px 0;text-shadow:0 0 15px rgba(0,255,149,.35)}
    h3{margin:10px 0 14px}
    .muted{color:var(--muted)}
    .hide{display:none!important}
    .ok{color:#00e676}
    .err{color:#ff6b6b}
    ul{margin:8px 0;padding-left:18px}
    li{margin:6px 0}
    /* Splash */
    #splash{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:5}
    #splash .pulse{width:14px;height:14px;border-radius:50%;background:#00ff95;box-shadow:0 0 16px #00ff95;animation:pulse 1.2s infinite}
    @keyframes pulse{0%{transform:scale(.9);opacity:.7}50%{transform:scale(1.25);opacity:1}100%{transform:scale(.9);opacity:.7}}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .block-btn{width:100%}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f0f0f;border:1px solid var(--line);margin-right:6px}
  </style>
</head>
<body>
  <!-- Splash -->
  <div id="splash"><div class="pulse"></div></div>

  <header class="container">
    <h1>Ball Knowledge</h1>
    <p class="muted">Analyze. Learn. Evolve.</p>
  </header>

  <!-- =========== ACCOUNT (only visible after splash) =========== -->
  <section class="card container" id="accountCard">
    <h3>Account</h3>
    <div class="grid">
      <div>
        <p class="muted">Create your account</p>
        <div class="row">
          <input id="su_name" type="text" placeholder="Full name">
          <input id="su_email" type="email" placeholder="Email">
        </div>
        <div class="row">
          <input id="su_password" type="password" placeholder="Create password">
          <input id="su_age" type="number" placeholder="Age">
          <input id="su_dob" type="date" placeholder="DOB">
        </div>
        <button id="signupBtn" class="block-btn">Sign Up</button>
      </div>
      <div>
        <p class="muted">Already have an account?</p>
        <div class="row">
          <input id="li_email" type="email" placeholder="Email">
          <input id="li_password" type="password" placeholder="Password">
        </div>
        <button id="loginBtn" class="block-btn">Login</button>
      </div>
    </div>
    <p id="authMsg" class="muted"></p>
  </section>

  <!-- =========== ANALYSIS (hidden until logged in) =========== -->
  <section class="card container hide" id="analysisCard">
    <h3>New Analysis</h3>

    <!-- Attributes -->
    <div class="grid">
      <div class="card" style="margin:0">
        <h4>Attributes</h4>
        <div class="row">
          <input id="height" type="number" placeholder="Height (cm)">
          <input id="weight" type="number" placeholder="Weight (kg)">
        </div>
        <div class="row">
          <select id="foot">
            <option value="" disabled selected>Dominant Foot</option>
            <option>Right</option><option>Left</option><option>Both</option>
          </select>
          <select id="position">
            <option value="" disabled selected>Position</option>
            <option>Goalkeeper</option>
            <option>Right Back</option><option>Center Back</option><option>Left Back</option>
            <option>Defensive Mid</option><option>Central Mid</option><option>Attacking Mid</option>
            <option>Right Wing</option><option>Left Wing</option><option>Striker</option>
          </select>
        </div>
        <p class="muted">We’ll pair these with your video to personalize feedback & drills.</p>
      </div>

      <!-- Video upload -->
      <div class="card" style="margin:0">
        <h4>Attach a Game Clip</h4>
        <div class="row">
          <input id="clipFile" type="file" accept="video/*">
          <button id="uploadBtn">Upload</button>
        </div>
        <p id="uploadMsg" class="muted"></p>
        <div id="clipInfo" class="muted"></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="row" style="margin-top:12px">
      <button id="analyzeBtn">Analyze</button>
      <span id="analyzeStatus" class="muted"></span>
    </div>

    <!-- Results -->
    <div id="results" class="hide" style="margin-top:12px">
      <h4>Your Report</h4>
      <div id="summary" class="muted" style="margin:8px 0 12px"></div>

      <div class="row">
        <div class="card" style="flex:1;min-width:280px">
          <h4>Focus Areas</h4>
          <ul id="focusList"></ul>
        </div>
        <div class="card" style="flex:1;min-width:280px">
          <h4>Suggested Drills</h4>
          <ul id="drillList"></ul>
        </div>
      </div>

      <div class="card">
        <h4>Plays Like</h4>
        <div id="comps"></div>
      </div>
    </div>
  </section>

  <script>
  /* =================== CONFIG =================== */
  const BASE =
    location.hostname.endsWith('github.io')
      ? 'https://ai-soccer-backend-2-production.up.railway.app'
      : '';

  // Cloudinary unsigned upload
  const CLOUD_NAME    = 'dblconpx8';
  const UPLOAD_PRESET = 'ballknowledge_unsigned';

  /* =================== HELPERS =================== */
  const $ = (id) => document.getElementById(id);
  const setToken = (t) => localStorage.setItem('bk_token', t);
  const getToken = () => localStorage.getItem('bk_token');
  const clearToken = () => localStorage.removeItem('bk_token');

  async function api(path, opts = {}) {
    const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
    const t = getToken();
    if (t) headers['Authorization'] = 'Bearer ' + t;
    const r = await fetch(`${BASE}${path}`, { ...opts, headers });
    return r.json();
  }

  function show(node){ node.classList.remove('hide') }
  function hide(node){ node.classList.add('hide') }

  /* =================== ELEMENTS =================== */
  const splash = $('splash');
  const accountCard  = $('accountCard');
  const analysisCard = $('analysisCard');
  const authMsg = $('authMsg');

  // signup/login fields
  const su_name=$('su_name'), su_email=$('su_email'), su_password=$('su_password'),
        su_age=$('su_age'),   su_dob=$('su_dob'),
        li_email=$('li_email'), li_password=$('li_password');

  const signupBtn=$('signupBtn'), loginBtn=$('loginBtn');

  // analysis fields
  const heightEl=$('height'), weightEl=$('weight'), footEl=$('foot'), positionEl=$('position');
  const clipFile=$('clipFile'), uploadBtn=$('uploadBtn'), uploadMsg=$('uploadMsg'), clipInfo=$('clipInfo');
  const analyzeBtn=$('analyzeBtn'), analyzeStatus=$('analyzeStatus');
  const results=$('results'), summary=$('summary'), focusList=$('focusList'), drillList=$('drillList'), comps=$('comps');

  /* =================== AUTH =================== */
  function setAuthMessage(t, ok=true){ authMsg.textContent=t; authMsg.className= ok ? 'ok' : 'err' }

  async function doSignup() {
    const payload = {
      name: su_name.value.trim(),
      email: su_email.value.trim(),
      password: su_password.value.trim(),
      age: Number(su_age.value||0),
      dob: su_dob.value
    };
    if (!payload.name || !payload.email || !payload.password || !payload.age || !payload.dob) {
      return setAuthMessage('Please complete all sign-up fields', false);
    }
    setAuthMessage('Creating your account…');
    const out = await api('/api/signup', { method:'POST', body: JSON.stringify(payload) });
    if (out.ok && out.token) {
      setToken(out.token);
      setAuthMessage(`Welcome, ${out.user?.name || payload.name}! ✅`, true);
      proceedToAnalysis();
    } else if (out.ok && out.user) {
      // if your /signup returns ok without token, auto-login:
      const li = await api('/api/login',{method:'POST', body: JSON.stringify({email:payload.email, password:payload.password})});
      if (li.ok && li.token){ setToken(li.token); proceedToAnalysis(); }
      else setAuthMessage(li.error || 'Login required after signup', false);
    } else {
      setAuthMessage(out.error || 'Signup failed', false);
    }
  }

  async function doLogin() {
    const email = li_email.value.trim();
    const password = li_password.value.trim();
    if (!email || !password) return setAuthMessage('Enter email & password', false);
    setAuthMessage('Logging in…');
    const out = await api('/api/login', { method:'POST', body: JSON.stringify({ email, password })});
    if (out.ok && out.token) { setToken(out.token); setAuthMessage('Logged in ✅', true); proceedToAnalysis(); }
    else setAuthMessage(out.error || 'Login failed', false);
  }

  function proceedToAnalysis(){
    hide(accountCard);
    show(analysisCard);
    setTimeout(()=>analysisCard.scrollIntoView({behavior:'smooth', block:'start'}), 50);
  }

  /* =================== CLOUDINARY UPLOAD =================== */
  async function uploadToCloudinary(file){
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);
    const r = await fetch(url,{method:'POST',body:fd});
    return r.json();
  }

  /* =================== ANALYZE =================== */
  let lastVideoUrl = '';

  async function doUpload(){
    const f = clipFile.files?.[0];
    if (!f){ uploadMsg.textContent='Pick a video first'; uploadMsg.className='err'; return; }
    uploadMsg.textContent='Uploading…'; uploadMsg.className='muted';
    try{
      const up = await uploadToCloudinary(f);
      if (up.secure_url){
        lastVideoUrl = up.secure_url;
        uploadMsg.textContent='Uploaded ✅'; uploadMsg.className='ok';
        clipInfo.innerHTML = `<span class="pill">${f.name}</span><a href="${up.secure_url}" target="_blank" class="muted">Open</a>`;
      } else {
        uploadMsg.textContent='Upload failed'; uploadMsg.className='err';
        console.warn('Cloudinary:', up);
      }
    }catch(e){
      uploadMsg.textContent='Network error'; uploadMsg.className='err';
      console.error(e);
    }
  }

  async function doAnalyze(){
    // gather attributes
    const attrs = {
      height: Number(heightEl.value||0),
      weight: Number(weightEl.value||0),
      foot:   footEl.value,
      position: positionEl.value
    };
    if (!lastVideoUrl) return analyzeStatus.textContent = 'Upload a video first';
    if (!attrs.height || !attrs.weight || !attrs.foot || !attrs.position){
      return analyzeStatus.textContent='Complete attributes first';
    }
    analyzeStatus.textContent='Analyzing… this can take a moment.';
    results.classList.add('hide');

    // Call your backend: POST /api/analyze
    // Expect shape:
    // { ok:true, summary:"...", focus:["…","…"], drills:[{title, url}], comps:["Player A","Player B"] }
    try{
      const out = await api('/api/analyze', {
        method:'POST',
        body: JSON.stringify({ videoUrl:lastVideoUrl, attributes: attrs })
      });

      if (!out.ok) {
        analyzeStatus.textContent = out.error || 'Analyze failed';
        return;
      }

      // Render results
      summary.textContent = out.summary || 'Summary not available.';
      focusList.innerHTML = (out.focus || []).map(x=>`<li>${x}</li>`).join('') || '<li class="muted">No items</li>';
      drillList.innerHTML = (out.drills || []).map(d=>`<li><a href="${d.url}" target="_blank">${d.title}</a></li>`).join('') || '<li class="muted">No drills</li>';
      comps.innerHTML = (out.comps || []).map(c=>`<span class="pill">${c}</span>`).join('') || '<span class="muted">No comps</span>';

      analyzeStatus.textContent='Done ✅';
      results.classList.remove('hide');
      results.scrollIntoView({behavior:'smooth', block:'start'});
    }catch(e){
      analyzeStatus.textContent='Network error';
      console.error(e);
    }
  }

  /* =================== WIRE UP =================== */
  signupBtn.onclick = doSignup;
  loginBtn.onclick  = doLogin;
  uploadBtn.onclick = doUpload;
  analyzeBtn.onclick= doAnalyze;

  // Splash → show only Account
  window.addEventListener('error', e => console.error('[FrontError]', e?.error||e?.message));
  setTimeout(()=>{ splash.classList.add('hide'); setTimeout(()=>splash.remove(), 400); }, 800);
  hide(analysisCard);
  show(accountCard);

  // If already logged in, jump to analysis.
  if (getToken()) { proceedToAnalysis(); }
  </script>
</body>
</html>
