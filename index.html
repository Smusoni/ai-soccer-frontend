 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ball Knowledge</title>
  <style>
    .menu-container {
  position: fixed;
  top: 20px;
  right: 30px;
  z-index: 1000;
}

.menu-icon {
  font-size: 28px;
  cursor: pointer;
  color: white;
  user-select: none;
  background-color: #111;
  border-radius: 8px;
  padding: 6px 10px;
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
}

.menu {
  display: none;
  flex-direction: column;
  position: absolute;
  right: 0;
  background-color: #111;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  padding: 10px 0;
  min-width: 150px;
  z-index: 10;
}

.menu a {
  color: white;
  text-decoration: none;
  padding: 10px 16px;
  display: block;
}

.menu a:hover {
  background-color: #333;
}
    :root{--bg:#0b0b0b;--card:#141414;--muted:#9aa0a6;--text:#e8eaed;--line:#222}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;padding:18px;margin:16px 0;border:1px solid var(--line)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f0f0f;color:var(--text)}
    input,select{min-width:220px}
    input::placeholder{color:#8a8f98}
    button{border:none;background:linear-gradient(90deg,#00ff95,#19d3ff);color:#000;font-weight:700;cursor:pointer}
    h1{font-size:36px;margin:8px 0;text-shadow:0 0 15px rgba(0,255,149,.35)}
    h3{margin:10px 0 14px}
    .muted{color:var(--muted)}
    .hide{display:none!important}
    .ok{color:#00e676}
    .err{color:#ff6b6b}
    ul{margin:8px 0;padding-left:18px}
    li{margin:6px 0}
    /* Splash */
    #splash{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:5}
    #splash .pulse{width:14px;height:14px;border-radius:50%;background:#00ff95;box-shadow:0 0 16px #00ff95;animation:pulse 1.2s infinite}
    @keyframes pulse{0%{transform:scale(.9);opacity:.7}50%{transform:scale(1.25);opacity:1}100%{transform:scale(.9);opacity:.7}}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .block-btn{width:100%}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f0f0f;border:1px solid var(--line);margin-right:6px
   
  /* Force app layers above stray loaders */
  #accountCard, #analysisCard, .menu-container {
    position: relative;
    z-index: 10;
  }

  </style>
</head>
<body>
  <!-- Hamburger Menu -->
<div class="menu-container">
  <div class="menu-icon" id="menuIcon">&#9776;</div>
  <div class="menu" id="menu">
    <a href="#" id="newAnalysis">New Analysis</a>
    <a href="#" id="library">Library</a>
    <a href="#" id="logout">Logout</a>
  </div>
</div>
  <!-- Splash -->
  <div id="splash"><div class="pulse"></div></div>

  <header class="container">
    <h1>Ball Knowledge</h1>
    <p class="muted">Analyze. Learn. Evolve.</p>
  </header>
  
  <!-- =========== ACCOUNT (only visible after splash) =========== -->
  <section class="card container" id="accountCard">
    <h3>Account</h3>
    <div class="grid">
      <div>
        <p class="muted">Create your account</p>
        <div class="row">
          <input id="su_name" type="text" placeholder="Full name">
          <input id="su_email" type="email" placeholder="Email">
        </div>
        <div class="row">
          <input id="su_password" type="password" placeholder="Create password">
          <input id="su_age" type="number" placeholder="Age">
          <input id="su_dob" type="date" placeholder="DOB">
        </div>
        <button id="signupBtn" class="block-btn">Sign Up</button>
      </div>
      <div>
        <p class="muted">Already have an account?</p>
        <div class="row">
          <input id="li_email" type="email" placeholder="Email">
          <input id="li_password" type="password" placeholder="Password">
        </div>
        <button id="loginBtn" class="block-btn">Login</button>
      </div>
    </div>
    <p id="authMsg" class="muted"></p>
  </section>

  <!-- =========== ANALYSIS (hidden until logged in) =========== -->
  <section class="card container hide" id="analysisCard">
    <h3>New Analysis</h3>

    <!-- Attributes -->
    <div class="grid">
      <div class="card" style="margin:0">
        <h4>Attributes</h4>
        <div class="row">
          <input id="height" type="number" placeholder="Height (cm)">
          <input id="weight" type="number" placeholder="Weight (kg)">
        </div>
        <div class="row">
          <select id="foot">
            <option value="" disabled selected>Dominant Foot</option>
            <option>Right</option><option>Left</option><option>Both</option>
          </select>
          <select id="position">
            <option value="" disabled selected>Position</option>
            <option>Goalkeeper</option>
            <option>Right Back</option><option>Center Back</option><option>Left Back</option>
            <option>Defensive Mid</option><option>Central Mid</option><option>Attacking Mid</option>
            <option>Right Wing</option><option>Left Wing</option><option>Striker</option>
          </select>
        </div>
        <p class="muted">Weâ€™ll pair these with your video to personalize feedback & drills.</p>
      </div>

      <!-- Video upload -->
      <div class="card" style="margin:0">
        <h4>Attach a Game Clip</h4>
        <div class="row">
          <input id="clipFile" type="file" accept="video/*">
          <button id="uploadBtn">Upload</button>
        </div>
        <p id="uploadMsg" class="muted"></p>
        <div id="clipInfo" class="muted"></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="row" style="margin-top:12px">
      <button id="analyzeBtn">Analyze</button>
      <span id="analyzeStatus" class="muted"></span>
    </div>

    <!-- Results -->
    <div id="results" class="hide" style="margin-top:12px">
      <h4>Your Report</h4>
      <div id="summary" class="muted" style="margin:8px 0 12px"></div>

      <div class="row">
        <div class="card" style="flex:1;min-width:280px">
          <h4>Focus Areas</h4>
          <ul id="focusList"></ul>
        </div>
        <div class="card" style="flex:1;min-width:280px">
          <h4>Suggested Drills</h4>
          <ul id="drillList"></ul>
        </div>
      </div>

      <div class="card">
        <h4>Plays Like</h4>
        <div id="comps"></div>
      </div>
    </div>
  </section>

 <script>
/* =================== CONFIG =================== */
const BASE =
  location.hostname.endsWith('github.io')
    ? 'https://ai-soccer-backend-2-production.up.railway.app'
    : '';

// Cloudinary unsigned upload
const CLOUD_NAME   = 'dblconpx8';
const UPLOAD_PRESET = 'ballknowledge_unsigned';

/* =================== HELPERS =================== */
const $ = (id) => document.getElementById(id);
const setToken   = (t) => localStorage.setItem('bk_token', t);
const getToken   = ()  => localStorage.getItem('bk_token');
const clearToken = ()  => localStorage.removeItem('bk_token');

async function api(path, opts = {}) {
  const headers = Object.assign({'Content-Type':'application/json'}, opts.headers || {});
  const t = getToken();
  if (t) headers['Authorization'] = 'Bearer ' + t;
  const r = await fetch(`${BASE}${path}`, { ...opts, headers });
  try { return await r.json(); } catch { return { ok:false, error:'Bad JSON' }; }
}

// simple show/hide
function show(el){ if(!el) return; el.classList.remove('hide'); el.style.display=''; }
function hide(el){ if(!el) return; el.classList.add('hide'); el.style.display='none'; }

/* ================ ELEMENT REFS (your IDs) ================ */
const accountCard = $('accountCard');   // login / signup card
const analysisCard = $('analysisCard'); // the analysis UI card
const authMsg = $('authMsg');

// signup/login fields
const su_name=$('su_name'), su_email=$('su_email'), su_password=$('su_password'),
      su_age=$('su_age'),   su_dob=$('su_dob'),
      li_email=$('li_email'), li_password=$('li_password');

const signupBtn=$('signupBtn'), loginBtn=$('loginBtn');

// analysis fields
const heightEl=$('height'), weightEl=$('weight'), footEl=$('foot'), positionEl=$('position');
const clipFile=$('clipFile'), uploadBtn=$('uploadBtn'), uploadMsg=$('uploadMsg'), clipInfo=$('clipInfo');
const analyzeBtn=$('analyzeBtn'), analyzeStatus=$('analyzeStatus');
const results=$('results'), summary=$('summary'), focusList=$('focusList'), drillList=$('drillList'), comps=$('comps');

// loader (black screen with the single dot)
const loading = document.getElementById('loading') || document.querySelector('.loading');
function hideLoading(){ if(loading) loading.style.display='none'; }
function showLoading(){ if(loading) loading.style.display='grid'; }

/* ================ HAMBURGER MENU (built in JS) ================ */
let menuContainer; // will be created once

function buildMenuOnce(){
  if (menuContainer) return; // already built

  // inject minimal styles (safe if you already added CSS)
  const css = `
  .menu-container{position:fixed;top:18px;right:24px;z-index:1000;display:none}
  .menu-icon{font-size:26px;line-height:26px;width:42px;height:42px;display:grid;place-items:center;cursor:pointer;color:#e5e7eb;background:#0b0b0b;border:1px solid #222;border-radius:10px;user-select:none}
  .menu{position:absolute;top:48px;right:0;min-width:180px;display:none;flex-direction:column;background:#0f0f10;border:1px solid #1f1f22;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);padding:8px}
  .menu.open{display:flex}
  .menu a,.menu button{all:unset;cursor:pointer;padding:10px 12px;border-radius:8px;color:#e5e7eb;font-size:14px;display:flex;align-items:center}
  .menu a:hover,.menu button:hover{background:#18181b}
  .menu .divider{height:1px;background:#232325;margin:6px 0}
  `;
  const style = document.createElement('style');
  style.innerText = css;
  document.head.appendChild(style);

  menuContainer = document.createElement('div');
  menuContainer.className = 'menu-container';
  menuContainer.setAttribute('data-hamburger','true');

  const icon = document.createElement('div');
  icon.className = 'menu-icon';
  icon.innerHTML = '&#9776;'; // â˜°

  const panel = document.createElement('div');
  panel.className = 'menu';
  panel.setAttribute('role','menu');

  const mkLink = (label, cb) => {
    const a = document.createElement('a');
    a.href = '#';
    a.textContent = label;
    a.addEventListener('click', (e)=>{ e.preventDefault(); panel.classList.remove('open'); cb && cb(); });
    return a;
  };

  const newAnalysis = mkLink('New Analysis', () => {
    hide(accountCard); show(analysisCard); hide(results);
    setTimeout(()=>analysisCard.scrollIntoView({behavior:'smooth',block:'start'}));
  });

  const library = mkLink('Library', () => {
    // TODO: wire to your real library page/section; placeholder for now
    alert('Library coming soon â€” link this to your history page/section.');
  });

  const divider = document.createElement('div'); divider.className = 'divider';

  const logout = document.createElement('button');
  logout.textContent = 'Logout';
  logout.addEventListener('click', () => {
    clearToken();
    // return to account screen without hard reload
    if (menuContainer) menuContainer.style.display = 'none';
    hide(analysisCard); show(accountCard); hide(results);
  });

  panel.append(newAnalysis, library, divider, logout);
  menuContainer.append(icon, panel);
  document.body.appendChild(menuContainer);

  // behavior
  icon.addEventListener('click', ()=> panel.classList.toggle('open'));
  window.addEventListener('click', (e)=>{
    if (!menuContainer.contains(e.target)) panel.classList.remove('open');
  });
}

/* ================= AUTH ================= */
function setAuthMessage(t, ok=true){ authMsg.textContent=t; authMsg.className = ok ? 'ok' : 'err'; }

async function doSignup(){
  const payload = {
    name: su_name.value.trim(),
    email: su_email.value.trim(),
    password: su_password.value.trim(),
    age: Number(su_age.value||0),
    dob: su_dob.value
  };
  if (!payload.name || !payload.email || !payload.password || !payload.age || !payload.dob){
    return setAuthMessage('Please complete all sign-up fields', false);
  }
  setAuthMessage('Creating your accountâ€¦');
  const out = await api('/api/signup', { method:'POST', body: JSON.stringify(payload) });
  if (out.ok && out.token){
    setToken(out.token); setAuthMessage(`Welcome, ${out.user?.name || payload.name}! âœ…`, true);
    proceedToAnalysis();
  } else if (out.ok && out.user){
    const li = await api('/api/login', { method:'POST', body: JSON.stringify({email:payload.email,password:payload.password}) });
    if (li.ok && li.token){ setToken(li.token); proceedToAnalysis(); }
    else setAuthMessage(li.error || 'Login required after signup', false);
  } else {
    setAuthMessage(out.error || 'Signup failed', false);
  }
}

async function doLogin(){
  const email = li_email.value.trim();
  const password = li_password.value.trim();
  if (!email || !password) return setAuthMessage('Enter email & password', false);
  setAuthMessage('Logging inâ€¦');
  const out = await api('/api/login', { method:'POST', body: JSON.stringify({email, password}) });
  if (out.ok && out.token){ setToken(out.token); setAuthMessage('Logged in âœ…'); proceedToAnalysis(); }
  else setAuthMessage(out.error || 'Login failed', false);
}

function proceedToAnalysis(){
  hide(accountCard);
  show(analysisCard);
  buildMenuOnce();
  if (menuContainer) menuContainer.style.display = 'block';
  hideLoading();
  setTimeout(()=>analysisCard.scrollIntoView({behavior:'smooth', block:'start'}));
}

/* ============== CLOUDINARY UPLOAD ============== */
async function uploadToCloudinary(file){
  const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  const r = await fetch(url, { method:'POST', body: fd });
  return await r.json();
}

/* ================= ANALYZE ================= */
let lastVideoUrl = '';

async function doUpload(){
  const f = clipFile.files?.[0];
  if (!f){ uploadMsg.textContent='Pick a video first'; uploadMsg.className='err'; return; }
  uploadMsg.textContent='Uploadingâ€¦'; uploadMsg.className='muted';
  try{
    const up = await uploadToCloudinary(f);
    if (up.secure_url){
      lastVideoUrl = up.secure_url;
      uploadMsg.textContent = 'Uploaded âœ…'; uploadMsg.className='ok';
      if (clipInfo) clipInfo.innerHTML = `<span class="pill">${f.name}</span><a href="${lastVideoUrl}" target="_blank">View</a>`;
    } else {
      uploadMsg.textContent='Upload failed'; uploadMsg.className='err';
      console.warn('Cloudinary:', up);
    }
  }catch(e){
    uploadMsg.textContent='Network error'; uploadMsg.className='err';
    console.error(e);
  }
}

async function doAnalyze(){
  analyzeStatus.textContent='Analyzingâ€¦'; analyzeStatus.className='muted';
  try{
    const payload = {
      height: Number(heightEl.value||0),
      weight: Number(weightEl.value||0),
      foot: footEl.value,
      position: positionEl.value,
      videoUrl: lastVideoUrl
    };
    if (!payload.videoUrl){
      analyzeStatus.textContent='Upload a clip first'; analyzeStatus.className='err'; return;
    }
    const out = await api('/api/analyze', { method:'POST', body: JSON.stringify(payload) });
    if (!out.ok){ analyzeStatus.textContent = out.error || 'Analyze failed'; analyzeStatus.className='err'; return; }

    // Render results
    summary.textContent = out.summary || 'Summary not available.';
    focusList.innerHTML = (out.focus || []).map(x=>`<li>${x}</li>`).join('');
    drillList.innerHTML = (out.drills || []).map(d=>`<li><a href="${d.url}" target="_blank">${d.title || d.url}</a></li>`).join('');
    comps.innerHTML     = (out.comps  || []).map(c=>`<span class="pill">${c}</span>`).join('');

    analyzeStatus.textContent='Done âœ…'; analyzeStatus.className='ok';
    results.classList.remove('hide');
    results.scrollIntoView({behavior:'smooth', block:'start'});
  }catch(e){
    analyzeStatus.textContent='Network error'; analyzeStatus.className='err';
    console.error(e);
  }
}

/* ================= WIRE UP ================= */
signupBtn && (signupBtn.onclick = doSignup);
loginBtn  && (loginBtn.onclick  = doLogin);
uploadBtn && (uploadBtn.onclick = doUpload);
analyzeBtn&& (analyzeBtn.onclick= doAnalyze);

/* ================= BOOTSTRAP ================= */
document.addEventListener('DOMContentLoaded', () => {
  try{
    buildMenuOnce(); // built early; stays hidden until logged in
    if (getToken()){
      // if already logged in, go straight to analysis and show menu
      hide(accountCard); show(analysisCard);
      if (menuContainer) menuContainer.style.display='block';
    } else {
      // logged out view
      if (menuContainer) menuContainer.style.display='none';
      hide(analysisCard); show(accountCard);
    }
  } finally {
    hideLoading(); // ALWAYS remove the black loading overlay
  }
});
/* ===== PATCH: force-hide any full-screen loader and route ===== */
(function() {
  function hideKnownLoaders() {
    const candidates = [
      '#loading', '.loading', '.loader', '.splash', '#splash',
      '[data-role="loading"]', '[data-loading="true"]'
    ];
    let hits = 0;
    for (const sel of candidates) {
      document.querySelectorAll(sel).forEach(el => {
        el.style.display = 'none';
        el.style.opacity = '0';
        el.style.pointerEvents = 'none';
        hits++;
      });
    }
    return hits;
  }

  // also catch generic full-screen overlays we don't know the selector for
  function hideGenericOverlays() {
    let hits = 0;
    const vw = window.innerWidth, vh = window.innerHeight;
    document.querySelectorAll('body *').forEach(el => {
      try {
        const s = getComputedStyle(el);
        if (s.position !== 'fixed') return;
        const r = el.getBoundingClientRect();
        const coverW = r.width / vw, coverH = r.height / vh;
        const looksDark = (c) => {
          // very rough check for dark backgrounds
          const m = c.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
          if (!m) return false;
          const [_, r_, g_, b_] = m.map(Number);
          return (r_+g_+b_) < 120*3;
        };
        if ((coverW > 0.8 && coverH > 0.8) && (looksDark(s.backgroundColor) || s.backdropFilter)) {
          el.style.display = 'none';
          el.style.opacity = '0';
          el.style.pointerEvents = 'none';
          hits++;
        }
      } catch(_) {}
    });
    return hits;
  }

  function routeByAuth() {
    const token = localStorage.getItem('bk_token');
    const accountCard = document.getElementById('accountCard');
    const analysisCard = document.getElementById('analysisCard');
    const menu = document.querySelector('.menu-container');

    const show = (el) => { if (!el) return; el.classList.remove('hide'); el.style.display=''; };
    const hide = (el) => { if (!el) return; el.classList.add('hide'); el.style.display='none'; };

    if (token) {
      hide(accountCard); show(analysisCard);
      if (menu) menu.style.display = 'block';
      console.log('[BOOT] token found â†’ analysis view');
    } else {
      if (menu) menu.style.display = 'none';
      show(accountCard); hide(analysisCard);
      console.log('[BOOT] no token â†’ account view');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const knownHits = hideKnownLoaders();
    const genericHits = hideGenericOverlays();
    console.log(`[PATCH] hid loaders â†’ known:${knownHits} generic:${genericHits}`);
    routeByAuth();
  });
})();
</script>
