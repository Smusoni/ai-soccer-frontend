<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ball Knowledge</title>

  <!-- Favicons (project path for GitHub Pages) -->
  <link rel="icon" type="image/png" sizes="32x32" href="/ai-soccer-frontend/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ai-soccer-frontend/favicon-16x16.png">

  <style>
    /* ================= Base Styles ================= */
    :root{--bg:#0b0b0b;--card:#141414;--muted:#9aa0a6;--text:#e8eaed;--line:#222}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;padding:18px;margin:16px 0;border:1px solid var(--line)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,select,button{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f0f0f;color:var(--text)}
    input,select{min-width:220px}
    input::placeholder{color:#8a8f98}
    button{border:none;background:linear-gradient(90deg,#00ff95,#19d3ff);color:#000;font-weight:700;cursor:pointer}
    h1{font-size:36px;margin:8px 0;text-shadow:0 0 15px rgba(0,255,149,.35)}
    h3{margin:10px 0 14px}
    .muted{color:var(--muted)}
    .hide{display:none!important}
    .ok{color:#00e676}
    .err{color:#ff6b6b}
    ul{margin:8px 0;padding-left:18px}
    li{margin:6px 0}

    /* ================= Splash Loader ================= */
    #splash{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:5}
    #splash .pulse{width:14px;height:14px;border-radius:50%;background:#00ff95;box-shadow:0 0 16px #00ff95;animation:pulse 1.2s infinite}
    @keyframes pulse{0%{transform:scale(.9);opacity:.7}50%{transform:scale(1.25);opacity:1}100%{transform:scale(.9);opacity:.7}}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .block-btn{width:100%}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f0f0f;border:1px solid var(--line);margin-right:6px}

    /* ================= Hamburger Menu ================= */
    .menu-container{position:fixed;top:20px;right:30px;z-index:1000;display:none}
    .menu-icon{font-size:28px;cursor:pointer;color:white;user-select:none;background-color:#111;border-radius:8px;padding:6px 10px;box-shadow:0 0 8px rgba(0,0,0,0.3)}
    .menu{display:none;flex-direction:column;position:absolute;right:0;background-color:#111;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.4);padding:10px 0;min-width:150px;z-index:10;max-height:70vh;overflow:auto}
    .menu a{color:white;text-decoration:none;padding:10px 16px;display:block}
    .menu a:hover{background-color:#333}

    /* ================= Header / Logo ================= */
    .app-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .app-header .brand{display:flex;align-items:center;gap:10px}
    #logo{height:36px;width:auto;display:block}
    @media (min-width:720px){#logo{height:42px}}
    #logoutTop{display:none}

    /* Ensure the menu icon is always visible on narrow desktop widths */
    @media (max-width: 1400px){
      .menu-container{ display:block !important; right:16px; top:16px; }
    }
    /* If a parent ever clips it, make sure we can see it */
    .app-header, header, body{ overflow: visible; }

    /* ================= Overlay Fix ================= */
    #accountCard, #analysisCard, #libraryPage, .menu-container{position:relative;z-index:10}
  </style>
</head>
<body>
  <!-- Hamburger Menu -->
  <div class="menu-container">
    <div class="menu-icon" id="menuIcon" aria-label="Open menu" role="button">&#9776;</div>
    <div class="menu" id="menu" role="menu">
      <a href="#" id="newAnalysis" role="menuitem">New Analysis</a>
      <a href="#" id="library" role="menuitem">Library</a>
      <a href="#" id="logout" role="menuitem">Logout</a>
    </div>
  </div>

  <!-- Splash -->
  <div id="splash"><div class="pulse"></div></div>

  <!-- Header with brand + LOGO (src set by script below) -->
  <header class="container app-header">
    <div class="brand">
      <img id="logo" alt="Ball Knowledge Logo">
      <h1>Ball Knowledge</h1>
    </div>

    <nav aria-label="breadcrumbs" style="display:flex;align-items:center;gap:10px">
      <a id="pageTag" class="muted" style="text-decoration:none; font-size:14px">Analysis</a>
      <button id="logoutTop" class="pill">Log out</button>
    </nav>

    <script>
      // Set the logo path deterministically so it works locally and on GitHub Pages
      (function () {
        const el = document.getElementById('logo');
        if (!el) return;
        const base = location.hostname.endsWith('github.io') ? '/ai-soccer-frontend' : '.';
        el.src = `${base}/ball-knowledge-high-resolution-logo.png`;
      })();
    </script>
  </header>

  <!-- =========== ACCOUNT (only visible after splash) =========== -->
  <section class="card container" id="accountCard">
    <h3>Account</h3>
    <div class="grid">
      <div>
        <p class="muted">Create your account</p>
        <div class="row">
          <input id="su_name" type="text" placeholder="Full name">
          <input id="su_email" type="email" placeholder="Email">
        </div>
        <div class="row">
          <input id="su_password" type="password" placeholder="Create password">
          <input id="su_age" type="number" placeholder="Age">
          <input id="su_dob" type="date" placeholder="DOB">
        </div>
        <button id="signupBtn" class="block-btn">Sign Up</button>
      </div>
      <div>
        <p class="muted">Already have an account?</p>
        <div class="row">
          <input id="li_email" type="email" placeholder="Email">
          <input id="li_password" type="password" placeholder="Password">
        </div>
        <button id="loginBtn" class="block-btn">Login</button>
      </div>
    </div>
    <p id="authMsg" class="muted"></p>
  </section>

  <!-- =========== ANALYSIS (hidden until logged in) =========== -->
  <section class="card container hide" id="analysisCard">
    <h3>New Analysis</h3>

    <!-- Attributes -->
    <div class="grid">
      <div class="card" style="margin:0">
        <h4>Attributes</h4>
        <div class="row">
          <input id="height" type="number" placeholder="Height (inches)">
          <input id="weight" type="number" placeholder="Weight (lbs)">
        </div>
        <div class="row">
          <select id="foot">
            <option value="" disabled selected>Dominant Foot</option>
            <option>Right</option><option>Left</option><option>Both</option>
          </select>
          <select id="position">
            <option value="" disabled selected>Position</option>
            <option>Goalkeeper</option>
            <option>Right Back</option><option>Center Back</option><option>Left Back</option>
            <option>Defensive Mid</option><option>Central Mid</option><option>Attacking Mid</option>
            <option>Right Wing</option><option>Left Wing</option><option>Striker</option>
          </select>
        </div>
        <p class="muted">We’ll pair these with your video to personalize feedback &amp; drills.</p>
      </div>

      <!-- Video upload -->
      <div class="card" style="margin:0">
        <h4>Attach a Training Clip</h4>
        <div class="row">
          <input id="clipFile" type="file" accept="video/*">
          <button id="uploadBtn">Upload</button>
        </div>
        <p id="uploadMsg" class="muted"></p>
        <div id="clipInfo" class="muted"></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="row" style="margin-top:12px">
      <button id="analyzeBtn">Analyze</button>
      <span id="analyzeStatus" class="muted"></span>
    </div>

    <!-- Results -->
    <div id="results" class="hide" style="margin-top:12px">
      <h4>Your Report</h4>
      <div id="summary" class="muted" style="margin:8px 0 12px"></div>

      <div class="row">
        <div class="card" style="flex:1;min-width:280px">
          <h4>Focus Areas</h4>
          <ul id="focusList"></ul>
        </div>
        <div class="card" style="flex:1;min-width:280px">
          <h4>Suggested Drills</h4>
          <ul id="drillList"></ul>
        </div>
      </div>
    </div>
  </section>

  <!-- =========== LIBRARY PAGE (separate screen) =========== -->
  <section class="card container hide" id="libraryPage" aria-labelledby="libraryTitle">
    <h3 id="libraryTitle">Your Library</h3>
    <p class="muted" id="libraryHint">Click a report to view or delete it.</p>
    <div id="libraryList"></div>
  </section>

  <script>
  /* =================== CONFIG =================== */
  const BASE =
    location.hostname.endsWith('github.io')
      ? 'https://ai-soccer-backend-2-production.up.railway.app'
      : (location.protocol === 'file:' ? 'http://localhost:8080' : '');

  // Cloudinary unsigned upload
  const CLOUD_NAME    = 'dblconpx8';
  const UPLOAD_PRESET = 'ballknowledge_unsigned';

  /* =================== HELPERS =================== */
  const $ = (id) => document.getElementById(id);
  const setToken   = (t) => localStorage.setItem('bk_token', t);
  const getToken   = ()  => localStorage.getItem('bk_token');
  const clearToken = ()  => localStorage.removeItem('bk_token');

  function show(el){ if(!el) return; el.classList.remove('hide'); el.style.display=''; }
  function hide(el){ if(!el) return; el.classList.add('hide'); el.style.display='none'; }

  async function api(path, opts = {}) {
    const headers = Object.assign({'Content-Type':'application/json'}, opts.headers || {});
    const t = getToken();
    if (t) headers['Authorization'] = 'Bearer ' + t;
    console.log('API →', (opts.method || 'GET'), path);
    const r = await fetch(`${BASE}${path}`, { ...opts, headers });
    try { return await r.json(); } catch { return { ok:false, error:'Bad JSON' }; }
  }

  /* ================ ELEMENT REFS ================ */
  const accountCard=$('accountCard'), analysisCard=$('analysisCard'), authMsg=$('authMsg');
  const heightEl=$('height'), weightEl=$('weight'), footEl=$('foot'), positionEl=$('position');
  const clipFile=$('clipFile'), uploadBtn=$('uploadBtn'), uploadMsg=$('uploadMsg'), clipInfo=$('clipInfo');
  const analyzeBtn=$('analyzeBtn'), analyzeStatus=$('analyzeStatus');
  const results=$('results'), summary=$('summary'), focusList=$('focusList'), drillList=$('drillList');

  // Library refs
  const libraryPage = $('libraryPage');
  const libraryList = $('libraryList');
  const pageTag     = $('pageTag');
  const logoutTop   = $('logoutTop');

  // splash
  const splash = document.getElementById('splash');
  function hideSplash(){ if (splash) splash.style.display='none'; }

  // menu
  const menuContainer=document.querySelector('.menu-container');
  const menuIcon=$('menuIcon'), menuPanel=$('menu');
  const newAnalysisLink=$('newAnalysis'), libraryLink=$('library'), logoutBtn=$('logout');

  menuIcon.addEventListener('click', ()=> {
    menuPanel.style.display = (menuPanel.style.display==='flex') ? 'none' : 'flex';
    if (menuPanel.style.display==='') menuPanel.style.display='flex';
  });
  window.addEventListener('click',(e)=>{
    if (!menuPanel.contains(e.target) && !menuIcon.contains(e.target)){ menuPanel.style.display='none'; }
  });

  /* =================== MINI ROUTER =================== */
  function goTo(screen){ // 'analysis' | 'library' | 'account'
    hide(accountCard); hide(analysisCard); hide(libraryPage);
    if (screen === 'analysis') { show(analysisCard); if (pageTag) pageTag.textContent='Analysis'; }
    else if (screen === 'library') { show(libraryPage); if (pageTag) pageTag.textContent='Library'; }
    else { show(accountCard); if (pageTag) pageTag.textContent='Account'; }
    if (screen !== 'account' && menuContainer) menuContainer.style.display='block';
  }
  function setHash(screen){ location.hash = `#/${screen}`; }
  function currentHash(){ return (location.hash || '').replace(/^#\//,''); }

  window.addEventListener('hashchange', () => {
    const page = currentHash();
    if (!getToken()) { goTo('account'); return; }
    if (page === 'library') { loadLibrary(); }
    else if (page === 'analysis') { goTo('analysis'); }
    else { setHash('analysis'); }
  });

  // Menu -> routes
  newAnalysisLink.addEventListener('click',(e)=>{
    e.preventDefault();
    menuPanel.style.display='none';
    setHash('analysis');
    hide(results); // start fresh
    setTimeout(()=>analysisCard.scrollIntoView({behavior:'smooth',block:'start'}));
  });
  libraryLink.addEventListener('click', (e)=>{
    e.preventDefault();
    menuPanel.style.display='none';
    setHash('library'); // hashchange will trigger loadLibrary()
  });

  /* ================= AUTH ================= */
  function setAuthMessage(t, ok=true){ authMsg.textContent=t; authMsg.className = ok ? 'ok' : 'err'; }

  const su_name=$('su_name'), su_email=$('su_email'), su_password=$('su_password'),
        su_age=$('su_age'),   su_dob=$('su_dob'),
        li_email=$('li_email'), li_password=$('li_password');

  async function doSignup(){
    const payload = {
      name: su_name.value.trim(),
      email: su_email.value.trim(),
      password: su_password.value.trim(),
      age: Number(su_age.value||0),
      dob: su_dob.value
    };
    if (!payload.name || !payload.email || !payload.password || !payload.age || !payload.dob){
      return setAuthMessage('Please complete all sign-up fields', false);
    }
    setAuthMessage('Creating your account…');
    const out = await api('/api/signup', { method:'POST', body: JSON.stringify(payload) });
    if (out.ok && out.token){
      setToken(out.token);

      // Save user profile to backend
      await api('/api/profile', {
        method: 'PUT',
        body: JSON.stringify({
          name: su_name.value.trim(),
          age: Number(su_age.value || 0),
          dob: su_dob.value || null
        })
      });

      setAuthMessage(`Welcome, ${out.user?.name || payload.name}! ✅`, true);
      proceedToAnalysis();
    } else if (out.ok && out.user){
      const li = await api('/api/login', { method:'POST', body: JSON.stringify({email:payload.email,password:payload.password}) });
      if (li.ok && li.token){ setToken(li.token); proceedToAnalysis(); }
      else setAuthMessage(li.error || 'Login required after signup', false);
    } else {
      setAuthMessage(out.error || 'Signup failed', false);
    }
  }

  async function doLogin(){
    const email = li_email.value.trim();
    const password = li_password.value.trim();
    if (!email || !password) return setAuthMessage('Enter email & password', false);
    setAuthMessage('Logging in…');
    const out = await api('/api/login', { method:'POST', body: JSON.stringify({email, password}) });
    if (out.ok && out.token){
      setToken(out.token);
      try { console.log('profile →', await api('/api/profile')); } catch {}
      setAuthMessage('Logged in ✅', true);
      proceedToAnalysis();
    } else {
      setAuthMessage(out.error || 'Login failed', false);
    }
  }

  function proceedToAnalysis(){
    setHash('analysis');
    if (menuContainer) menuContainer.style.display='block';
    if (logoutTop) logoutTop.style.display = 'inline-block';
    hideSplash();
    setTimeout(()=>analysisCard.scrollIntoView({behavior:'smooth', block:'start'}));
  }

  /* ============== LOGOUT (menu + header) ============== */
  function doLogout() {
    clearToken();
    try { menuPanel.style.display = 'none'; } catch {}
    try { menuContainer.style.display = 'none'; } catch {}
    if (logoutTop) logoutTop.style.display = 'none';
    setHash('account');
    goTo('account');
    hide(results);
  }
  if (logoutBtn) logoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); doLogout(); });
  if (logoutTop) logoutTop.addEventListener('click', (e)=>{ e.preventDefault(); doLogout(); });

  /* ============== CLOUDINARY UPLOAD ============== */
  let lastVideoUrl = '', lastPublicId = '';

  async function uploadToCloudinary(file){
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', UPLOAD_PRESET);
    const r = await fetch(url, { method:'POST', body: fd });
    return await r.json();
  }

  async function doUpload() {
    const f = clipFile.files?.[0];
    if (!f) {
      uploadMsg.textContent = 'Pick a video first';
      uploadMsg.className = 'err';
      return;
    }
    uploadMsg.textContent = 'Uploading…';
    uploadMsg.className = 'muted';

    try {
      const up = await uploadToCloudinary(f);

      if (up.secure_url) {
        lastVideoUrl = up.secure_url;
        lastPublicId = up.public_id || '';

        uploadMsg.textContent = 'Uploaded ✅';
        uploadMsg.className = 'ok';
        if (clipInfo)
          clipInfo.innerHTML = `<span class="pill">${f.name}</span> 
                                <a href="${lastVideoUrl}" target="_blank">View</a>`;

        // persist clip metadata
        await api('/api/clip', {
          method: 'POST',
          body: JSON.stringify({
            url: up.secure_url,
            public_id: up.public_id,
            created_at: up.created_at || new Date().toISOString(),
            bytes: up.bytes || f.size,
            duration: up.duration || null,
            width: up.width || null,
            height: up.height || null,
            format: up.format || f.type
          })
        });
      } else {
        uploadMsg.textContent = 'Upload failed';
        uploadMsg.className = 'err';
        console.warn('Cloudinary upload issue:', up);
      }
    } catch (e) {
      uploadMsg.textContent = 'Network error';
      uploadMsg.className = 'err';
      console.error(e);
    }
  }

  /* ==================== ANALYZE ==================== */
  async function doAnalyze(){
    analyzeStatus.textContent='Analyzing…';
    analyzeStatus.className='muted';

    try{
      const payload = {
        height: Number(heightEl.value||0),
        weight: Number(weightEl.value||0),
        foot: footEl.value,
        position: positionEl.value,
        videoUrl: lastVideoUrl,
        publicId: lastPublicId
      };
      if (!payload.videoUrl){
        analyzeStatus.textContent='Upload a clip first';
        analyzeStatus.className='err';
        return;
      }

      const out = await api('/api/analyze', { method:'POST', body: JSON.stringify(payload) });
      if (!out.ok || !out.item){
        analyzeStatus.textContent = out.error || 'Analyze failed';
        analyzeStatus.className='err';
        return;
      }

      // Immediately load the saved report using the same flow as Library → View
      analyzeStatus.textContent='Done ✅ Saved to your Library.';
      analyzeStatus.className='ok';

      await viewAnalysis(out.item.id);   // shows full report on Analysis page
    }catch(e){
      analyzeStatus.textContent='Network error';
      analyzeStatus.className='err';
      console.error(e);
    }
  }

  /* ================ LIBRARY (its own page) ================ */
  let libraryCache = [];

  function renderLibrary(items){
    goTo('library');
    libraryList.innerHTML = items.length
      ? items.map(i => `
          <div class="card" data-id="${i.id}">
            <div class="muted" style="font-size:12px">${new Date(i.created_at).toLocaleString()}</div>
            <div style="margin:6px 0">${i.summary ? i.summary : '(no summary saved)'}</div>
            <div class="row" style="gap:8px">
              ${i.video_url ? `<a class="block-btn" style="flex:0 0 auto;padding:6px 10px" href="${i.video_url}" target="_blank">Watch clip</a>` : ''}
              <button class="block-btn" style="flex:0 0 auto;padding:6px 10px" data-action="view" data-id="${i.id}">View</button>
              <button class="block-btn" style="flex:0 0 auto;padding:6px 10px;background:#ff6b6b" data-action="delete" data-id="${i.id}">Delete</button>
            </div>
          </div>
        `).join('')
      : `<div class="muted">No saved analyses yet. Upload a clip and press Analyze to create one.</div>`;
  }

  async function loadLibrary(){
    try{
      const res = await api('/api/analyses');
      if (!res.ok) throw new Error(res.error || 'Failed to load library');
      libraryCache = res.items || [];
      renderLibrary(libraryCache);
    }catch(e){
      alert(e.message || 'Could not load library');
    }
  }

  async function viewAnalysis(id){
    try{
      const res = await api(`/api/analyses/${id}`);
      if (!res.ok) throw new Error(res.error || 'Not found');

      const a = res.item || {};
      goTo('analysis');

      summary.textContent = a.summary || 'Summary not available.';
      focusList.innerHTML = (a.focus || []).map(x=>`<li>${x}</li>`).join('');
      drillList.innerHTML = (a.drills || []).map(d=>`<li><a href="${d.url}" target="_blank">${d.title || d.url}</a></li>`).join('');

      results.classList.remove('hide');
      results.scrollIntoView({ behavior:'smooth', block:'start' });

    }catch(e){
      alert(e.message || 'Could not open analysis');
    }
  }

  async function deleteAnalysis(id){
    if (!confirm('Delete this analysis?')) return;
    try{
      const res = await api(`/api/analyses/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error(res.error || 'Delete failed');
      libraryCache = libraryCache.filter(x => x.id !== id);
      renderLibrary(libraryCache);
    }catch(e){
      alert(e.message || 'Could not delete');
    }
  }

  // Event delegation for library buttons
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;
    const action = t.getAttribute('data-action');
    const id = t.getAttribute('data-id');
    if (!action || !id) return;

    if (action === 'view'){
      e.preventDefault();
      viewAnalysis(id);
    } else if (action === 'delete'){
      e.preventDefault();
      deleteAnalysis(id);
    }
  });

  /* ================= WIRE UP ================= */
  const signupBtnEl = $('signupBtn');
  const loginBtnEl  = $('loginBtn');
  const uploadBtnEl = $('uploadBtn');
  const analyzeBtnEl= $('analyzeBtn');

  signupBtnEl && (signupBtnEl.onclick = doSignup);
  loginBtnEl  && (loginBtnEl.onclick  = doLogin);
  uploadBtnEl && (uploadBtnEl.onclick = doUpload);
  analyzeBtnEl&& (analyzeBtnEl.onclick= doAnalyze);

  /* ================= BOOTSTRAP ================= */
  document.addEventListener('DOMContentLoaded', () => {
    try{
      if (getToken()){
        if (menuContainer) menuContainer.style.display='block';
        if (logoutTop) logoutTop.style.display = 'inline-block';
        const page = currentHash();
        if (page === 'library') { loadLibrary(); }
        else { setHash('analysis'); }
      } else {
        if (menuContainer) menuContainer.style.display='none';
        if (logoutTop) logoutTop.style.display = 'none';
        goTo('account');
      }
    } finally {
      hideSplash();
    }
  });
  </script>
</body>
</html>
